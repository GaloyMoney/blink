load('./config.tiltfile', 'run_apps')

local_resource(
  name='init-onchain',
  labels = ['init'],
  cmd='buck2 run //dev:init-onchain',
  allow_parallel = True,
  resource_deps = [
    "bitcoind",
    "bria",
  ]
)

local_resource(
  name='init-lightning',
  labels = ['init'],
  cmd='buck2 run //dev:init-lightning',
  allow_parallel = True,
  resource_deps = [
    "init-onchain",
    "lnd1",
    "lnd-outside-1",
    "lnd-outside-2",
  ]
)

local_resource(
  name='init-test-user',
  labels = ['init'],
  cmd='buck2 run //dev:init-test-user',
  allow_parallel = True,
  resource_deps = [
    "oathkeeper",
    "kratos",
    "api",
  ]
)

local_resource(
  name='init-test-users-with-usernames',
  labels = ['init'],
  cmd='buck2 run //dev:init-test-users-with-usernames',
  allow_parallel = True,
  resource_deps = [
    "oathkeeper",
    "kratos",
    "api",
  ]
)

local_resource(
  name='init-voucher-hydra-client',
  labels = ['init'],
  cmd=[
    'buck2',
    'run',
    '//dev:setup-hydra-client',
    '--',
    'voucher',
    'authorization_code,refresh_token',
    'http://localhost:3006/api/auth/callback/blink',
  ],
  allow_parallel = True,
  resource_deps = [
    "hydra",
    "api",
  ]
)

local_resource(
  name='init-consent-hydra-client',
  labels = ['init'],
  cmd=[
    'buck2',
    'run',
    '//dev:setup-hydra-client',
    '--',
    'consent-test',
    'authorization_code,refresh_token',
    'http://localhost:3000',
  ],
  allow_parallel = True,
  auto_init = run_apps,
  resource_deps = [
    "hydra",
    "api",
  ]
)

local_resource(
  name='init-user-funds',
  labels = ['init'],
  cmd='buck2 run //dev:init-user-funds',
  allow_parallel = True,
  resource_deps = [
    "oathkeeper",
    "kratos",
    "api",
    "init-onchain",
    "init-test-user",
    "api-trigger",
    "stablesats",
    "price",
  ]
)

local_resource(
    name="init-voucher-escrow",
    labels = ['init'],
    cmd="buck2 run //dev:setup-voucher-escrow",
    allow_parallel=False,
    auto_init=run_apps,
    resource_deps=["voucher-pg", "api-keys"]
)
