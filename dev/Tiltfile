groups = {
    "core": [
        "mongodb",
        "redis",
    ],
    "bitcoin": [
        "lnd1",
        "bria",
        "postgres-bria",
        "fulcrum",
        "bitcoind-signer",
        "bitcoind",
    ],
    "tracing": [
      "otel-agent",
    ],
}

api_target = "//core/api:api"
local_resource(
    "api",
    labels = ["core"],
    cmd = "buck2 build {}".format(api_target),
    serve_cmd = "buck2 run {}".format(api_target),
    serve_env = {
        "HELMREVISION": "dev",
        "NETWORK": "regtest",
        "OATHKEEPER_DECISION_ENDPOINT": "http://localhost:4456",
        "TWILIO_ACCOUNT_SID": "AC_twilio_id",
        "TWILIO_AUTH_TOKEN": "AC_twilio_auth_token",
        "TWILIO_VERIFY_SERVICE_ID": "VA_twilio_service",
        "KRATOS_PG_CON": "postgres://dbuser:secret@localhost:5433/default?sslmode=disable",
        "KRATOS_PUBLIC_API": "http://localhost:4433",
        "KRATOS_ADMIN_API": "http://localhost:4434",
        "KRATOS_MASTER_USER_PASSWORD": "passwordHardtoFindWithNumber123",
        "KRATOS_CALLBACK_API_KEY": "The-Value-of-My-Key",
        "BRIA_HOST": "localhost",
        "BRIA_API_KEY": "bria_dev_000000000000000000000",
        "MONGODB_CON": "mongodb://localhost:27017/galoy",
        "REDIS_MASTER_NAME": "mymaster",
        "REDIS_PASSWORD": "",
        "REDIS_0_DNS": "localhost",
        "REDIS_0_PORT": "6379",
        "REDIS_TYPE": "standalone",
    },
    allow_parallel = True,
    readiness_probe = probe(
        period_secs  = 5,
        http_get = http_get_action(
            path = "healthz",
            port = 4012,
        ),
    ),
    resource_deps = [
        "init-onchain",
        "lnd1",
    ]
)

docker_compose("./docker-compose.deps.yml", project_name = "galoy-dev")

for service in groups["bitcoin"]:
    dc_resource(service, labels = ["bitcoin"])
for service in groups["tracing"]:
    dc_resource(service, labels = ["tracing"])
for service in groups["core"]:
    dc_resource(service, labels = ["core"])

local_resource(
  name='init-onchain',
  labels = ['bitcoin'],
  cmd='bin/init-onchain.sh',
  resource_deps = [
    "bitcoind",
    "bria",
  ]
)
