#!/usr/bin/env python3
"""
Downloads and installs packages via Pnpm.
"""
import argparse
import os
import shutil
import subprocess
import sys

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "--root-dir",
        help="Path to the root",
    )
    parser.add_argument(
        "node_modules_out_path",
        help="Path to output `node_modules`",
    )

    args = parser.parse_args()

    cmd = ["pnpm", "install", "--frozen-lockfile"]

    # Set cwd appropriately - use provided root_dir if available, otherwise current directory
    cwd = args.root_dir if args.root_dir and args.root_dir.strip() else None

    exit_code = subprocess.call(cmd, cwd=cwd)

    if exit_code == 0:
        # If no root_dir was provided, use current directory
        src_dir = args.root_dir if args.root_dir and args.root_dir.strip() else "."
        src = os.path.join(src_dir, "node_modules")
        dest = os.path.join(args.node_modules_out_path, "node_modules")

        # Ensure the source exists
        if not os.path.exists(src):
            print(f"Error: Source directory {src} does not exist", file=sys.stderr)
            sys.exit(1)

        # Ensure the parent directory exists (not the destination itself)
        parent_dir = os.path.dirname(dest)
        os.makedirs(parent_dir, exist_ok=True)

        # Remove destination if it exists
        if os.path.exists(dest):
            if os.path.islink(dest):
                os.unlink(dest)
            else:
                shutil.rmtree(dest)

        try:
            # Make the source path absolute before creating the symlink
            src_absolute = os.path.abspath(src)
            # Create a symbolic link instead of copying
            os.symlink(src_absolute, dest, target_is_directory=True)
        except Exception as e:
            print(f"Error creating symlink: {e}", file=sys.stderr)
            sys.exit(1)

    sys.exit(exit_code)
