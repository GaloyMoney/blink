#!/usr/bin/env python3
"""
Downloads and installs packages via Pnpm.
"""
import argparse
import os
import shutil
import subprocess
import sys

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "--pnpm-lock",
        help="Path to lockfile",
    )
    parser.add_argument(
        "--package-json",
        help="Path to package.json",
    )
    parser.add_argument(
        "--workspace-override",
        help="Path to dummy pnpm-workspace.yaml",
    )
    parser.add_argument(
        "node_modules_out_path",
        help="Path to output `node_modules`",
    )

    args = parser.parse_args()

    if not os.path.exists(args.node_modules_out_path):
        os.makedirs(args.node_modules_out_path)

    shutil.copy(args.pnpm_lock, os.path.join(args.node_modules_out_path, 'pnpm-lock.yaml'))
    shutil.copy(args.package_json, os.path.join(args.node_modules_out_path, 'package.json'))
    shutil.copy(args.workspace_override, os.path.join(args.node_modules_out_path, 'pnpm-workspace.yaml'))


    cmd = ["pnpm", "install", "--frozen-lockfile"]

    exit_code = subprocess.call(cmd, cwd=args.node_modules_out_path)
    sys.exit(exit_code)

